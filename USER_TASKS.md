# 用户操作清单 - 微信开发者工具

## 📱 前置准备

### 1. 安装微信开发者工具
- 下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
- 选择对应平台（Windows / Mac / Linux）
- 安装并登录微信

### 2. 注册小程序账号
- 访问：https://mp.weixin.qq.com/
- 注册账号（如果还没有）
- 登录后获取 **AppID**（位置：开发 → 开发设置）

### 3. 开通云开发
- 在小程序管理后台 → 云开发 → 开通
- 免费额度通常足够个人使用
- 创建环境后获取 **环境 ID**

---

## 🔧 项目导入步骤

### Step 1: 打开项目
1. 启动微信开发者工具
2. 点击「导入项目」
3. 填写项目信息：
   ```
   项目目录：/workspace/projects/projects/stock-cost-manager/
   AppID：填写你的小程序 AppID
   项目名称：持股成本管理
   开发模式：小程序
   后端服务：云开发
   ```

### Step 2: 配置云环境
1. 点击顶部工具栏「云开发」按钮
2. 选择或创建云开发环境
3. 记下环境 ID（类似：cloud1-xxx）

4. 修改 `miniprogram/app.js`，找到：
   ```javascript
   wx.cloud.init({
     env: '你的环境ID'
   })
   ```

---

## ☁️ 云函数部署

### 部署 get-quote（实时报价）
1. 在项目树中找到 `cloudfunctions/get-quote/`
2. 右键点击该文件夹 → 选择「上传并部署：云端安装依赖」
3. 等待部署完成（会显示绿色勾）
4. 在云开发控制台 → 云函数中查看是否已上线

### 部署 get-stock-info（股票信息）
1. 找到 `cloudfunctions/get-stock-info/`
2. 右键点击 → 「上传并部署：云端安装依赖」
3. 等待部署完成
4. 在云开发控制台验证

### 部署 calculate-cost（成本计算）⭐ 新增
1. 找到 `cloudfunctions/calculate-cost/`
2. 右键点击 → 「上传并部署：云端安装依赖」
3. 等待部署完成
4. 在云开发控制台验证

**云函数测试：**
- 在云开发控制台 → 云函数 → calculate-cost
- 点击「测试」
- 输入测试参数（首次买入）：
  ```json
  {
    "stockCode": "600000",
    "stockName": "浦发银行",
    "region": "cn",
    "type": 1,
    "price": 10.00,
    "quantity": 100,
    "fee": 5.00
  }
  ```
- 预期返回：
  ```json
  {
    "code": 0,
    "message": "买入成功",
    "data": {
      "action": "create",
      "quantity": 100,
      "avgCost": 10.05
    }
  }
  ```

---

## 🗄️ 数据库创建

### 创建 positions 集合
1. 点击顶部「云开发」→「数据库」
2. 点击「添加集合」
3. 填写集合名称：`positions`
4. 权限设置：选择「仅创建者可写，所有人可读」
5. 点击确定

### 创建 transactions 集合
1. 点击「添加集合」
2. 填写集合名称：`transactions`
3. 权限设置：选择「仅创建者可写，所有人可读」
4. 点击确定

---

## ✅ 测试验证

### 基础功能测试
1. **编译并预览**
   - 点击「编译」按钮
   - 检查控制台是否有错误

2. **添加持仓测试**
   - 点击底部「添加」标签
   - 输入股票代码（如：600000）
   - 点击提交
   - 检查是否跳转到持仓列表

3. **云函数测试**
   - 在云开发控制台 → 云函数 → get-quote
   - 点击「测试」
   - 输入：
     ```json
     {
       "code": "600000"
     }
     ```
   - 查看返回结果是否包含实时行情数据

4. **成本计算测试** ⭐ 新增
   - 在云开发控制台 → 云函数 → calculate-cost
   - 点击「测试」
   - 输入首次买入参数：
     ```json
     {
       "stockCode": "600000",
       "stockName": "浦发银行",
       "region": "cn",
       "type": 1,
       "price": 10.00,
       "quantity": 100,
       "fee": 5.00
     }
     ```
   - 预期成本价：10.05
   - 再次测试加仓：
     ```json
     {
       "stockCode": "600000",
       "stockName": "浦发银行",
       "region": "cn",
       "type": 1,
       "price": 11.00,
       "quantity": 100,
       "fee": 5.00
     }
     ```
   - 预期成本价：10.55

---

## 🐛 常见问题排查

### 问题 1：云函数部署失败
**可能原因：**
- 云开发环境未开通
- 云函数依赖安装失败

**解决方法：**
- 确认云开发已开通
- 查看云函数日志了解详细错误

### 问题 2：数据库操作失败
**可能原因：**
- 权限设置错误
- 集合名称不匹配

**解决方法：**
- 检查数据库权限设置
- 确认集合名称与代码中一致

### 问题 3：API 调用失败
**可能原因：**
- iTick API Key 未配置或失效
- 网络请求域名未配置

**解决方法：**
- 检查 `CONFIG.md` 中的 API Key 配置
- 在小程序管理后台配置服务器域名（如果需要）

---

## 📞 遇到问题？

如果遇到问题，可以：
1. 查看云开发控制台的「日志」和「监控」
2. 检查开发者工具的「控制台」输出
3. 把错误信息发给我，我帮你分析

---

## ⚡ 快速开始（最简步骤）

如果你已经有小程序账号和云开发环境：

1. **导入项目** → 填 AppID 和环境 ID
2. **部署云函数** → 右键三个云函数文件夹 → 上传（get-quote、get-stock-info、calculate-cost）
3. **创建数据库** → 添加两个集合（positions、transactions）
4. **测试运行** → 编译 → 添加一只股票试试
5. **验证成本计算** → 使用 TEST_CASES.md 中的测试用例

预计时间：**15-20 分钟** ⏱️

---
